# istar 室内手机定位导航系统 #

## ABSTRACT ##

The adoption of indoor navigation for smartphones has been relatively
slow in the past years, although it would be direly needed in complex
indoor areas. The primary barriers for its adoption include the lack
of ne-grained and up-to-date indoor maps and the potential
deployment and maintenance cost. 在这篇论文里面，我们基于SweetHome3D这
个工具来进行三维建模和参考照片管理，对大部分的建筑物（机场候机厅、大型
超市等）可以简单和快速的生成初始数据，并且当建筑物内部装修发生变化之后，
也只需要很短的时间和很低的成本完成数据更新。我们开发了 iStar 这个室内定
位导航系统，并且通过学校的一个十层左右（每层大约500平方米）的教学楼来评
估它的功能和性能。

iStar 使用 SweetHome3D 通过导入建筑物的平面图来快速构建三维模型，在建筑
物内每一个区域使用深度相机拍摄参考照片，并把参考照片的拍摄位置、角度等
添加到三维模型中。因为参考照片包含深度信息，我们可以根据参考照片生成的
关键点和对应的三维坐标。通过使用参考照片的相关数据，iStar 支持使用照片
关键点匹配的方式来定位拍摄者的位置和角度。为了缩短定位时间，iStar 把建
筑物分为不同的区域，并使用 Wifi-Finger 来选择区域。按照我们的实验结果，
与同类的室内定位导航系统相比，iStar 有相当大的竞争优势：在大多数情况下，
用户定位的响应时间在3.5秒之内，并且定位精度小于60cm。

为了快速生成 iStar 定位需要的参考照片数据和Wifi指纹数据，我们为
SweetHome3D 编写了专门的数据转换插件。通过这些插件，iStar 系统维护者只
需要拍摄深度照片、在SweetHome3D中记录拍摄位置和角度，把建筑物内部的AP型
号添加到 SweetHome3D 中，然后就可以同步转换更新到 iStar 数据库，这样，
即便建筑物内部装修发生了变化，iStar 更新的工作量和成本也很低。

同时在 iStar 运行过程中，iStar 会根据用户的查询照片来调整和修改参考照片，
也会根据用户的Wifi数据来调整建筑物内部的Wifi指纹数据库，使得iStar的数据
库始终和建筑物保持一致。

## INTRODUCTION ##

和 iMoon 使用公众照片来建立三维模型不同，iStar 直接使用平面图来建立三维
模型

和 iMoon 使用 sfm 技术，利用公众照片重建三维模型不同，iStar 使用
SweetHome3D 工具直接建立三维模型，并使用深度相机来拍摄参考照片。对参考
照片，使用 asift 算法提前得到其中的关键点描述符，这样做有下列好处

* 拍摄照片的数量不需要很多，拍摄一张照片，使用 asift 算法将其旋转之后，
  基本相当于每隔一定角度，就拍摄一张照片的效果

* asift 算法匹配度很高，相应的特别耗费时间，所以提前使用 asift 算法生成
  关键点，而在手机定位的时候，查询照片直接使用 ORB 算法，即有效的提高了
  关键点的匹配度，又基本不影响定位的时间

* 使用深度相机得到的关键点的三维坐标精度会比 sfm 高

* 通过我们自己开发的 Swh 插件，可以方便的导入参考照片，系统维护人员只需
  要把参考照片的拍摄位置和拍摄角度添加到SWH的模型中，剩下的事情会由我们
  的插件来完成

* 拍摄照片选取的关键点一般为固定不变的参考物，这样，照片基本不需要更新。
  只有当建筑物进行了装修，参照物发生了变化，才需要重新拍摄

对于Wifi指纹定位，iStar 辅助以等高线定位法，这样Wifi的数据初始化可以直
接添加 AP 到SWH中，然后根据 AP 的辐射模型，进行简化处理，只考虑墙壁的影
响，计算出每一个 AP 在三维模型中等高线。这样做的好处在于

* Wifi初始化数据不需要耗时很多的测试，而是直接根据模型进行计算

* 计算工作由插件自动完成，即便以后 AP 位置发生了变化，只要在 SWH 中把
  AP 的位置修改一下，然后就可以使用插件自动更新Wifi数据库

* 辐射模型可以通过用户进行查询时候通过手机传送过来的实际数据进行修正

和iMoon 不同的是，iStar 系统在手机端来执行照片匹配和定位。首先手机传送
当前Wifi指纹到服务器，服务器根据Wifi指纹得到备选区域，并将备选区域的参
考照片对应的关键点描述符传送给手机，手机应用会将当前拍摄的照片和这些关
键点进行匹配，找到匹配的照片之后发送信息给服务器，服务器再把匹配照片对
应关键点的三维坐标发送给手机，手机使用这些数据进行定位。这种方式的好处
在于

* 大大减轻了服务器的计算负担，因为匹配算法就消耗CPU资源，当用户数量达到
  一定程度之后，集中处理的方式会把服务器累趴下

* 不需要手机上传照片到服务器，而是服务器传送参考照片的数据到手机，这样
  即便手机照片很大，也不存在网络传输问题。而服务器传过来的参考数据一般
  会在 1M 以内

* 照片匹配使用 ORB 算法，每张照片的匹配基本都在毫秒级，定位时间会大大缩
  短

因为现在大多数手机都有电子罗盘的传感器，可以得到当前手机的朝向，参考
[HTML 5 DeviceOrientation Specification]<http://www.w3.org/TR/orientation-event/>
虽然电子罗盘会存在一定的误差，但是以此为参考，可以大大提高定位的精度。

## SYSTEM OVERVIEW ##

## BUILDING 3D MODELS OF INDOOR ENVIRONMENTS ##

### Initializing and Updating SWH-based 3D Models ###

## 3D-MODEL-BASED INDOOR NAVIGATION ##

### Indoor Localization ###

### Compiling Navigation Meshes ###

### Generating Navigation Instructions ###

## EVALUATION ##

### Methodology ###

### Data Collection ###

### Accuracy of Navigation Mesh ###

### Performance of 3D-model-based Indoor Localization ###

##### Hit Rate #####

#### Accuracy ####

#### Robustness ####

### Summary ###

## DISCUSSION AND FUTUREWORK ##

## 概念 ##

这里定义了 istar 中使用的一些概念。

### 建筑物 （building) ###

建筑物是 istar 系统用于定位的最大区域，定位总是基于当前是在已知的建筑物之内。也就是说，istar 的定位算法是在一栋建筑物之内进行的。

### 房间 (room) ###

房间是建筑物的组成部分，房间是指长宽都小于阀值（例如10米），周围都有墙或者遮挡物的封闭空间。

### 大厅（hall）###

这里的大厅并不局限于开阔空间，建筑物除了房间之外的其他区域都成为大厅，例如楼梯，走廊等也属于大厅。

### 定位区域（located region）###

定位区域是大厅内部的任何一个多边形区域，是 wifi 定位的基本单位。在 istar 系统中，使用三角网络划分区域，使用中心点标识区域。

### 特征平面对象（feature-plane object) ###

特征平面对象是用于定位的数据源，它是根据参考照片生成，包含一个平面物体
的所有特征点和对应的三维坐标等信息。在本文中，参考照片有时候就代表着特
征平面对象。

定位区域和特征平面对象的关系如下

* 一个定位区域可以包含一个或者多个特征平面对象

* 一个特征平面对象可能属于多个定位区域

### 活力指数（vigor index) ###

用来衡量特征平面对象的活跃度，当用户使用 istar 系统进行定位的时候，那些
经常被匹配的参考照片活力指数就比较高，而那些不被匹配或者匹配经常出错的
参考照片，活力指数就比较低。

### 生存竞争（struggle for existence）###

根据活力指数来筛选同一个定位区域内部的特征平面对象的算法策略，在同一个
定位区域内，活力指数比较高的照片被优先来匹配，活力指数太低的照片根本不
参与匹配（被淘汰）。

## 面临的问题和解决方案

* 问题一：如果覆盖整个定位区域

首先要保证在定位区域内部，向任何一个方向拍摄照片，可以进行定位。我们允
许使用二次定位，也就是说，任何方向在180度视野里面肯定会包含参照物，但是，
相机法线和参考平面之间的夹角，最大值为 90度，也就是正好和相机底片平行。

* 问题二：参考照片和当前方向角度很大

这就是最大的挑战，asift 算法是一个解决方案，但是存在一些问题，对于大角
度（超过60度），需要的关键点数目比较多，计算时间一般以 分 为单位，对于
用户导航定位来说，是不可接受的。

coffee_images/  就是很好的实验数据，用这个来证明。

* 问题三： 在不同光照情况下，如何匹配

即便是室内，也有窗口透光，白天和夜晚，晴天和阴天，阴天的时候开灯和关灯
等不同情况下，如何匹配？

对于遮挡，要求用户定位的时候，取景要面向竖直的固定物体，不要有人或者其
他遮挡。试想一下，如果周围都是人的话，使用相机定位只有一种方式：用相机
对准屋顶。


## 参考数据初始化 ##

istar 在使用之前需要进行数据的初始化，我们以西北大学某一栋教学楼为例，来进行说明。

* 使用 SweetHome 创建教学楼三维模型
* 使用三角网络定义定位区域，例如 r0, r1, r2
* 初始化 wifi 数据
* 初始化定位区域的参考照片数据

### 参考照片初始化 ###

使用普通手机和简单测量工具（卷尺）即可。

#### 照片拍摄点选取和照片采集 ####

* 选择大厅（房间）的四面墙壁、立柱以及其他固定的竖直平面上的丰富特征区
  域，基本原则是固定不动的平面物体，例如招牌，地图，画幅、空调挂机等
  （需要在实践中总结），至少拍一张，多则不限。

* 正对平面物体，距离调整到平面基本填充画面60%~80%左右（需要在实践中总
  结），进行拍摄

* 记录拍摄点和参考平面之间的距离，以及参考平面的拍摄中心位置

* 如果拍摄点和参考平面之间无法直接测量，需要平移30cm~50cm，拍下另外一张
  照片，记录下偏移距离，这样根据两张照片和拍摄点的相对偏移，就可以计算
  出拍摄点和参考平面的距离

#### 参考照片初始化算法 ####

把采集的参考照片以及相关的记录数据传入到 istar 系统中，生成相应的特征平
面对象。下面是算法流程图

![](ref-photo.jpg)

### 使用平面特征物进行定位的特点 ###

* 照片里面的平面物体，使用 asift 算法之后，可以匹配不同角度的查询照片，
  如果不使用asift算法，那么当手机拍摄的查询照片和参考平面有较大的角度时
  候，就无法匹配

* 因为是采用一个参考平面来定位，所以关键点会都在一个平面上，我们使用的
  定位算法可以进行特殊处理，从而提高定位精度，在我们的教学楼实验中，能
  够达到 60cm（需要充分的实验数据来证明）

* 参考照片采集简单，使用普通手机和普通测量工具即可，需要记录少，一般就
  是参考平面的位置，以及相机与参考平面的距离（如果拍两张照片或者使用深
  度相机，就不需要知道和参考平面的距离，适用于无法测量的场景，例如隔着
  水池的屏风）。

* 定位区域采样数量小，甚至只需要一张就可以，解决了大厅或者房间的某些方
  向存在的关键点很少的问题。当然了，对于个别区域，四周都很空阔，不存在
  参考平面，那么称之为不可定位区域， 是 istar 的盲点，但是如果这种定位
  区域在整栋楼里面所占比率比较小，就是可以接受的。

## 照片定位原理和算法 ##

下图是在定位区域已经确定的情况下（使用wifi定位），根据用户照片进行定位
的算法

![](locate-photo.jpg)

通过上图我们可以看到，用户每一次定位请求，有可能需要拍两次，第二次是转
身之后在拍一张，那么，两张照片基本就是当前位置的全景，所以即便只有一个
方向的参考照片，也应该可以匹配出来，对于用户来说，大部分情况一次拍照即
可定位成功，少数情况拍两次也是可以接受的。通过这种方式，一个定位区域只
需要一张参考照片，就可以进行定位，而不是必须要有全方位的参考照片。

每一个定位区域，在数据初始化的时候参考照片可能有多个，通过生存竞争算法，
在用户使用的过程中，最后可能只有那些被用的最多的照片生存了下来，其他的
都被淘汰了。

注意：同一个参考照片，可能被多个定位区域引用，活力指数是累加的。

### 生存竞争算法特点 ###

* 允许在 istar 运行的过程中添加新的参考照片，参与到生存竞争中去

* 能够提高参考照片的匹配成功率，减少参考照片对比量，从而减少定位响应时间

在理想状况下，每个定位区域在经过一段时间的淘汰之后，都会剩下一张参考照
片，或者只需要使用第一张照片，就能够满足该区域的大部分的定位请求。

每一张参考照片使用 asift 算法产生的关键点数目在 1万~2万之间，而每一张查
询照片直接使用 orb 的关键点数目是2000个（这是默认 istar 设置的最多关键
点数目）。每少一张照片就相当于少了 2000 个关键点和 2万个关键点的匹配时
间，这对定位响应时间的减少是很有帮助的。


## semi-crowdsourcing ##

semi-crowdsourcing

iStar 使用半众包的思路来进行初始化构建，所谓半众包是指部分工作是有组织
完成，剩下的则有群众自发完成。以一个大型超市为例，在这里部署室内导航
iStar 系统而进行的初始化构建中

1. 超市的整体三维结构模型是组织（公司）完成，这部分可以根据建筑平面图，
   使用SweetHome快速搭建

2. 超市中的各个分区的参考照片则由其中的商户自己拍照，上传到 iStar 中

超市中的各个商户将照片上传到 iStar 系统中，相当于是免费给自己做广告，因
为那些来商城的客户如果使用 iStar 来进行导航，就会或多或少看到这些照片，
这样商户会积极主动的上传照片。

iStar 系统对商户上传的照片要求很少，只需要拍照的提供相对位置就可以，在
添加照片的时候，会显示超市的三维图让商户指定自己的拍摄位置

## 参考 ##


In simple words, Fundamental Matrix F, maps a point in one image to a line (epiline) in the other image.

Refer to https://docs.opencv.org/3.2.0/da/de9/tutorial_py_epipolar_geometry.html

Homography H is a perspective transformation between the source and the destination plane.
