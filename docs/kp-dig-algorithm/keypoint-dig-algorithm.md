# 关键点挖掘算法

## 概述

本文主要提出了一种拍摄角度改变之后的关键点匹配算法——关键点挖掘算法（keypoint dig algorithm)。

例如，参考照片为 

[IMG_1968.JPG](images/coffee/IMG_1968.JPG)

查询照片为 

[IMG_1973.JPG](images/coffee/IMG_1973.JPG)

本算法适用于参考照片正面拍摄，查询照片在侧面的任意角度。

## 问题

我们匹配的重点是咖啡馆墙上的那幅画，在参考照片中，是正对着相机，而在查询照片中，则存在不小的角度。

对于照片拍摄角度改变等仿射变换的匹配算法，已经有人提出专门的算法 asift： <http://www.ipol.im/pub/art/2011/my-asift/article_lr.pdf>

但在我们使用 asift + orb 匹配上面的例子中，却无法得到匹配结果。经过各种参数组合的实验，发现 asift 在我们的实际应用中，存在如下问题，

* asift 使用 orb 特征描述符 无法匹配查询照片
* asift 使用 sift 特征描述符，可以匹配出来，但是关键点数目必须很多，每一次取样为 2000，共 43 次取样，共计 8 万多个关键点，需要耗时五分钟左右

而在我们的实际需求中，要求每一次匹配时间在一秒左右的范围，这就是我们面临的挑战。

## 分析和解决

在实验中我们发现，在关键点数目比较少时候，即便是 asift 算法，有些区域甚至没有任何关键点，例如下图

[IMG_1973-asift-10-orb-2000](result/IMG_1973-asift.orb.jpg)

这是 asift 取样 10次 ，使用 orb 描述符 每一次取样最大 2000 个关键点得到的结果，注意到墙上的那幅画中一个关键点也没有。

分析发现这是因为 orb 算法在选择关键点的时候，会优先选择那些特征比较强的，而墙上的画因为角度关系，其关键点特征太弱而没有被发现。

但是如果我们单独选择这片区域，直接使用 orb 算法去搜索的话，还是有很多关键点显示出来的，例如下图

[IMG_1973-orb-1000](result/IMG_1973-orb.jpg)

这就给我们提供了一种解决的思路，只要能把这些比较弱的关键点找出来就可以实现正确的匹配，其中的一个方法就是：

* 把这些强的关键点从图片中删除，然后再次搜索，如此循环，总会找到这些比较弱的关键点

下面是一个实例，使用 orb 算法，每次最多搜索 2000 个关键点。每搜索一次，就在图片中删除发现的关键点，然后再次搜索，直到没有关键点为止

### 第一次搜索

关键点 

[1/IMG_1973-orb.jpg](result/1/IMG_1973-orb.jpg)

匹配结果 

[1/IMG_1968-IMG_1973.jpg](result/1/IMG_1968-IMG_1973.jpg)

查询照片中图画区根本关键点，匹配当然很差

### 第二次搜索

下面是在图片中删除第一次发现的 2000 个关键点之后，再次搜索和匹配的结果

关键点 

[2/IMG_1973-orb.jpg](result/2/IMG_1973-orb.jpg)

匹配结果 

[2/IMG_1968-IMG_1973.jpg](result/2/IMG_1968-IMG_1973.jpg)

图画区还是一片空白，继续搜索

### 第三次搜索

[3/IMG_1973-orb.jpg](result/3/IMG_1973-orb.jpg)
[3/IMG_1968-IMG_1973.jpg](result/3/IMG_1968-IMG_1973.jpg)

这一次图画区终于出现了部分绿点，有所发现，努力没有白费，但是关键点匹配数目太少，才9个，匹配效果不理想。

### 第四次搜索

[4/IMG_1973-orb.jpg](result/4/IMG_1973-orb.jpg)
[4/IMG_1968-IMG_1973.jpg](result/4/IMG_1968-IMG_1973.jpg)

这一次图画区绿意盎然，这就是期望的关键点，终于挖掘出来了，而且匹配数目为达到 43 个（我们的阀值是30个），匹配效果也很好。

到了这一步的就不需要在继续，但还是把结果列出，到第7次就没有关键点了

[5/IMG_1973-orb.jpg](result/5/IMG_1973-orb.jpg)
[5/IMG_1968-IMG_1973.jpg](result/5/IMG_1968-IMG_1973.jpg)

[6/IMG_1973-orb.jpg](result/6/IMG_1973-orb.jpg)
[6/IMG_1968-IMG_1973.jpg](result/6/IMG_1968-IMG_1973.jpg)

[7/IMG_1973-orb.jpg](result/7/IMG_1973-orb.jpg)

经过使用其他照片多次试验，我们发现对于这种大角度的倾斜匹配，通常也就需要三、四次就可以发现目标，而每次搜索和匹配的时间一般都在500毫米以下。

这就是关键点挖掘算法的原理。

## 算法实现

。。。
